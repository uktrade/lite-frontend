{% extends 'layouts/case.html' %}

{% load advice_tags crispy_forms_tags custom_tags rules static tau_tags %}

{% block header_tabs %}
    <div id="tab-bar" class="app-case-tab-bar">
        <div class="govuk-width-container lite-tabs__container">
            <div class="lite-tabs ">
                {% include "includes/case-tabs.html" %}
            </div>
        </div>
    </div>
{% endblock %}

{% block full_width %}
    <div class="govuk-width-container">
        <main class="govuk-main-wrapper assessment-form tau-assessment-form">
            <div class="govuk-grid-row assessment-form__display--flex">
                <!-- Heading -->
                <div class="govuk-grid-column-two-thirds">
                    {% if unassessed_goods %}
                        <h1 class="govuk-heading-l">Product assessment</h1>
                        <p id="subtitle" class="govuk-body">Assess {{ unassessed_goods|length }} product{{ unassessed_goods|pluralize }} going from <strong>{{ case.data.goods_starting_point|verbose_goods_starting_point }}</strong> to <strong>{{ case|get_destinations|humanise_list }}</strong></p>
                    {% endif %}
                </div>
                <!-- Move case forward form -->
                {% test_rule 'can_user_move_case_forward' current_user case as can_user_move_case_forward %}
                {% if can_user_move_case_forward  %}
                    <div class="govuk-grid-column-one-third">
                        {% if not unassessed_goods and is_tau and not is_all_cases_queue %}
                            <div class="govuk-grid-column-full" style="text-align: right;">
                                <form action="{% url 'cases:tau:move_case_forward' queue_id case.id %}" method="POST">
                                    {% csrf_token %}
                                    <input class="govuk-button" type="submit" value="Move case forward">
                                </form>
                            </div>
                        {% endif %}
                    </div>
                {% endif %}
            </div>

            <!-- Form -->
            <div class="govuk-grid-row">
                {% if unassessed_goods %}
                    {{ cle_suggestions_json|json_script:"cle-suggestions-json" }}
                    <form id="tau-form" action="." method="POST" {% if form.helper.attrs.enctype %}enctype="{{ form.helper.attrs.enctype }}"{% endif %}>
                        <div class="govuk-grid-column-two-thirds assessment-form__first-column">
                            {{ form.goods|as_crispy_field }}
                        </div>

                        <div class="govuk-grid-column-one-third assessment-form__second-column">
                            <h1 class="govuk-heading-m assessment-form__headline"></h1>
                            {% crispy form %}
                            {% test_rule 'can_user_assess_products' current_user case as can_user_assess_products %}
                            {% if can_user_assess_products %}
                                <input type="submit" name="submit" value="Save and continue" class="govuk-button" id="submit-id-submit" />
                            {% endif %}
                        </div>
                    </form>
                {% endif %}
            </div>

            <!-- Assessed products table -->
            {% if assessed_goods %}
                <div class="govuk-grid-row">
                    <div class="govuk-grid-column-full">
                        <table id="assessed-products" class="govuk-table">
                            <h2 class="govuk-heading-m">Assessed products</h2>
                            {% test_rule 'can_user_assess_products' current_user case as can_user_assess_products %}
                            {% if can_user_assess_products %}
                                <a id="clear-assessments-button" href="{% url 'cases:tau:clear_assessments' queue_pk=queue_id pk=case.id %}" class="govuk-button govuk-button--secondary" data-module="govuk-button">Clear assessments</a>
                            {% endif %}
                            <thead class="govuk-table__head">
                                <tr class="govuk-table__row">
                                    <th scope="col" class="govuk-table__header">
                                        <span class="govuk-visually-hidden">Line number</span>
                                    </th>
                                    <th scope="col" class="govuk-table__header">Name</th>
                                    <th scope="col" class="govuk-table__header">Control entry</th>
                                    <th scope="col" class="govuk-table__header">Licence</th>
                                    <th scope="col" class="govuk-table__header">Regime</th>
                                    <th scope="col" class="govuk-table__header">Report summary</th>
                                    <th scope="col" class="govuk-table__header govuk-!-width-one-quarter">Assessment notes and evidence</th>
                                    <th scope="col" class="govuk-table__header">
                                        <span class="govuk-visually-hidden">Actions</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="govuk-table__body">
                                {% for good in assessed_goods %}
                                    <tr class="govuk-table__row">
                                        <td class="govuk-table__cell">{{ good.line_number }}.</td>
                                        <td class="govuk-table__cell">{{ good.good.name }}</td>
                                        <td class="govuk-table__cell">{{ good | get_clc | join:',' }}</td>
                                        <td class="govuk-table__cell">{{ good.is_good_controlled.value }}</td>
                                        <td class="govuk-table__cell">
                                            {% for regime_entry in good.regime_entries %}
                                                {{ regime_entry.shortened_name|default:regime_entry.name }}<br>
                                            {% endfor %}
                                        </td>
                                        <td class="govuk-table__cell">{{ good.report_summary|default:"" }}</td>
                                        <td class="govuk-table__cell">{{ good.comment|linebreaksbr }}</td>
                                        <td class="govuk-table__cell">
                                            <a class="govuk-link govuk-link--no-visited-state" href="{% url 'cases:tau:edit' queue_pk=queue_id pk=case.id good_id=good.id %}">Edit</a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endif %}
        </main>
    </div>
{% endblock %}

{% block javascript %}
    {{ block.super }}
    <script src="{% static 'tau.js' %}" type="text/javascript"></script>
{% endblock %}
